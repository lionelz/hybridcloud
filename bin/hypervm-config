#!/bin/bash
set -x

CONF_DIRS="/etc/neutron /etc/hybridcloud"
PARAMS="rabbit_userid rabbit_host rabbit_password host local_ip"

function get_user_data {
    # get user data from 169.254.169.254
    USER_DATA=`curl http://169.254.169.254/latest/user-data/`
    for data in $USER_DATA; do
        set -- `echo $data | tr '=' ' '`
        export $1=$2
    done;
}

# try to mount the cdrom
mount -o user,exec,utf8 -t iso9660 /dev/sr0 /media/metadata

if [ $? -eq 0 ]; then
    if [ -f "/media/metadata/userdata.txt" ]
    then
        source /media/metadata/userdata.txt
    else
        # get the metadata from 169.254.169.254
        echo "a cdrom is present but no user data file"
        # try to read for user data from 169.254.169.254
        get_user_data
    fi
else
    # try to read for user data from 169.254.169.254
    get_user_data
fi

export local_ip=`ip -o -4 a | grep eth0 | awk -e '{print $4}' | cut -f1 -d'/'`

# replace the tmpl values
sed_command=""
for p in $PARAMS; do
   val=${!p}
   sed_command=`echo "s/##$p##/${val//\//\\\/}/g;$sed_command"`
done;
echo $sed_command

for d in $CONF_DIRS; do
   for f_tmpl in `find $d -name "*.tmpl"`; do
      f="${f_tmpl%.*}"
      sed $f_tmpl -e $sed_command > $f
   done;
done;

# echo $host > /etc/hostname
# hostname $host
# grep -v 127.0.0.1 /etc/hosts > /tmp/hosts.bk2
# echo '127.0.0.1 localhost '$host > /tmp/hosts.bk1
# cat /tmp/hosts.bk1 /tmp/hosts.bk2 > /etc/hosts
